{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dealer Dashboard | SMG Portal</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script>
function calculateTotal() {
    let labourBoxes = document.querySelectorAll('input[name="services"]:checked');
    let partBoxes = document.querySelectorAll('input[name="components"]:checked');  // <-- updated
    let total = 0.0;
    labourBoxes.forEach(cb => total += parseFloat(cb.dataset.cost || 0));
    partBoxes.forEach(cb => total += parseFloat(cb.dataset.price || 0));
    document.getElementById('totalCost').innerText = '₹ ' + total.toFixed(2);
}
</script>


</head>
<body class="bg-white">
<div class="container mt-4">
    <h4 class="text-primary">Welcome, {{ dealer.name }}</h4>
    <div class="mt-3 mb-4">
        <h5 class="text-primary">Quick Access</h5>
        <a href="{% url 'test_ride_form' %}" class="btn btn-outline-success btn-sm me-2">Customer Test Ride</a>
        <a href="{% url 'customer_feedback_form' %}" class="btn btn-outline-info btn-sm me-2">Customer Feedback</a>
        <a href="{% url 'dealer_quotation' %}" class="btn btn-outline-primary btn-sm mt-2">Quotation Maker</a>
        <a href="#" class="btn btn-outline-secondary btn-sm disabled">PDI Inspection Sheet (Coming Soon)</a>
    </div>

    <a href="{% url 'dealer_add_inventory' %}" class="btn btn-outline-primary btn-sm mt-2">Manage Inventory</a>
    <p class="text-muted">Dealer ID: {{ dealer.dealer_id }}</p>

    {% if message %}
    <div class="alert alert-success">{{ message }}</div>
    {% endif %}

    <div class="card p-3 mt-3 shadow">
        <h5 class="text-primary">Add Customer Service Record</h5>
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-4 mb-2">
                    <input type="text" name="customer_name" class="form-control" placeholder="Customer Name" required>
                </div>
                <div class="col-md-4 mb-2">
                    <input type="text" name="customer_phone" class="form-control" placeholder="Customer Phone No" required>
                </div>
                <div class="col-md-4 mb-2">
                    <input type="date" name="date_of_sale" class="form-control" required>
                </div>
                <div class="col-md-4 mb-2">
                    <input type="date" name="last_service_date" class="form-control" required>
                </div>
                <div class="col-md-4 mb-2">
                    <input type="number" name="service_kms" class="form-control" placeholder="Service (in kms)" required>
                </div>
            </div>

            <h6 class="mt-3 text-primary">Select Services</h6>
            <div class="row border p-2" style="max-height: 200px; overflow-y: scroll;">
                {% for s in labour_services %}
                <div class="col-md-6">
                    <label>
                        <input type="checkbox" name="services" value="{{ s.id }}" data-cost="{{ s.cost }}" onchange="calculateTotal()"> {{ s.description }} (₹{{ s.cost }})
                    </label>
                </div>
                {% endfor %}
            </div>

            <h6 class="mt-3 text-primary">Select Components (if any replaced)</h6>
            <div class="row border p-2" style="max-height: 200px; overflow-y: scroll;">
                {% for p in components %}
                <div class="col-md-6 mb-1">
                    <label>
                        <input type="checkbox" name="components" value="{{ p.id }}" data-price="{{ p.price }}" onchange="calculateTotal()">
                        <strong>{{ p.part_code }}</strong> - {{ p.part_name }}
                        {% if p.model %}<small>(Model: {{ p.model.name }})</small>{% endif %}
                        <br>
                        Price: ₹{{ p.price }}
                    </label>
                </div>
                {% endfor %}
            </div>


            <h6 class="mt-3">Total Estimate: <span id="totalCost" class="text-success">₹ 0</span></h6>

            <button type="submit" class="btn btn-primary mt-3">Save Service</button>
        </form>
    </div>

    <div class="card p-3 mt-4 shadow">
        <h5 class="text-primary">Inventory Summary</h5>
        <table class="table table-bordered mt-2">
            <thead class="table-light">
                <tr>
                    <th>Part Name</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in inventory %}
                <tr>
                    <td>{{ inv.component.part_name }}</td>
                    <td>
                        {% if inv.quantity <= 2 %}
                            <span class="text-danger fw-bold">{{ inv.quantity }} (Low!)</span>
                        {% else %}
                            <span class="text-success fw-bold">{{ inv.quantity }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="text-center text-muted">No inventory added yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{% url 'dealer_add_inventory' %}" class="btn btn-outline-primary btn-sm mt-2">Manage Inventory</a>
    </div>

    <div class="card p-3 mt-4 shadow">
        <h5 class="text-primary">Previous Service Records</h5>
        <table class="table table-bordered mt-2">
            <thead class="table-primary">
                <tr>
                    <th>Customer</th>
                    <th>Phone</th>
                    <th>Date of Sale</th>
                    <th>Last Service</th>
                    <th>Kms</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody>
                {% for s in services %}
                <tr>
                    <td>{{ s.customer_name }}</td>
                    <td>{{ s.customer_phone }}</td>
                    <td>{{ s.date_of_sale }}</td>
                    <td>{{ s.last_service_date }}</td>
                    <td>{{ s.service_kms }}</td>
                    <td>{{ s.created_at|date:"d-m-Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted">No service records yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
</body>
</html>
